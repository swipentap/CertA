name: Test and Create Tag

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: judyandiealvarez/certa

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
      
    - name: Restore dependencies
      run: dotnet restore CertA/CertA.csproj
      
    - name: Build
      run: dotnet build CertA/CertA.csproj --no-restore
      
    - name: Test
      run: dotnet test CertA/CertA.csproj --no-build --verbosity normal

  create-tag:
    needs: [test]
    runs-on: ubuntu-latest
    environment: public
    permissions:
      contents: write
      actions: write
      id-token: write
    steps:
    - name: Verify PAT token is available
      run: |
        if [ -z "${{ secrets.GH_PAT }}" ]; then
          echo "WARNING: GH_PAT secret is not available, will use GITHUB_TOKEN"
        else
          echo "GH_PAT secret is available (length: ${#GH_PAT} chars)"
        fi
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Configure git remote with PAT token
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        if [ -n "$GH_TOKEN" ]; then
          echo "Configuring git remote with PAT token"
          git remote set-url origin https://$GH_TOKEN@github.com/${{ github.repository }}.git
        else
          echo "GH_TOKEN not available, using default authentication"
        fi
    
    - name: Fetch all tags
      run: |
        git fetch --tags --force
    
    - name: Extract version
      id: version
      run: |
        # Get latest tag or use 0.0.0
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        BASE_VERSION=${LATEST_TAG#v}
        # Increment patch version
        IFS='.' read -ra VERSION_PARTS <<< "$BASE_VERSION"
        MAJOR=${VERSION_PARTS[0]:-0}
        MINOR=${VERSION_PARTS[1]:-0}
        PATCH=${VERSION_PARTS[2]:-0}
        PATCH=$((PATCH + 1))
        VERSION="${MAJOR}.${MINOR}.${PATCH}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
    
    - name: Create git tag
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        TAG=${{ steps.version.outputs.tag }}
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists, skipping"
        else
          git tag -a "$TAG" -m "Release $TAG"
          git remote set-url origin https://$GH_TOKEN@github.com/${{ github.repository }}.git
          git push origin "$TAG"
          echo "Tag $TAG created and pushed."
        fi
    
    - name: Verify tag creation
      if: steps.version.outputs.tag != ''
      run: |
        TAG=${{ steps.version.outputs.tag }}
        echo "âœ… Tag $TAG was created and pushed"
