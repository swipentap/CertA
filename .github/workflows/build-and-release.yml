name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_run:
    workflows: ["Test and Create Tag"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  IMAGE_NAME: judyandiealvarez/certa

jobs:
  get-latest-tag:
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.tag.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}
      has-new-tag: ${{ steps.tag.outputs.has-new-tag }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get latest tag
      id: tag
      run: |
        # Get the commit SHA from the triggering workflow run
        TRIGGERING_SHA="${{ github.event.workflow_run.head_sha }}"
        echo "Triggering workflow SHA: $TRIGGERING_SHA"
        
        # Fetch all tags
        git fetch --tags --force
        
        # Find the tag that points to the triggering workflow's commit
        TAG_FOR_COMMIT=$(git tag --points-at "$TRIGGERING_SHA" | grep "^v" | sort -V | tail -1)
        
        if [ -n "$TAG_FOR_COMMIT" ]; then
          echo "‚úÖ Found tag $TAG_FOR_COMMIT pointing to triggering workflow commit"
          LATEST_TAG="$TAG_FOR_COMMIT"
          HAS_NEW_TAG="true"
        else
          # Fallback: get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          LATEST_TAG_SHA=$(git rev-parse "$LATEST_TAG" 2>/dev/null || echo "")
          echo "‚ö†Ô∏è  No tag found for triggering commit, using latest tag: $LATEST_TAG (SHA: $LATEST_TAG_SHA)"
          HAS_NEW_TAG="false"
        fi
        
        VERSION=${LATEST_TAG#v}
        # Ensure tag format is correct (with 'refs/tags/' prefix for checkout)
        TAG_REF="refs/tags/$LATEST_TAG"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG_REF" >> $GITHUB_OUTPUT
        echo "has-new-tag=$HAS_NEW_TAG" >> $GITHUB_OUTPUT
        echo "Tag ref for checkout: $TAG_REF"

  test:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    needs: [get-latest-tag]
    permissions:
      contents: read
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'workflow_run' && needs.get-latest-tag.outputs.tag || github.ref }}
      
    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
      
    - name: Restore dependencies
      run: dotnet restore CertA/CertA.csproj
      
    - name: Build
      run: dotnet build CertA/CertA.csproj --no-restore
      
    - name: Test
      run: dotnet test CertA/CertA.csproj --no-build --verbosity normal

  build-docker:
    runs-on: ubuntu-latest
    needs: [test, get-latest-tag]
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && needs.get-latest-tag.outputs.has-new-tag == 'true')
    environment: public
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Configure git remote and checkout tag
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        TAG_REF="${{ github.event_name == 'workflow_run' && needs.get-latest-tag.outputs.tag || (startsWith(github.ref, 'refs/tags/') && github.ref || '') }}"
        if [ -n "$TAG_REF" ] && [ "$TAG_REF" != "refs/heads/main" ]; then
          if [ -n "$GH_TOKEN" ]; then
            echo "Configuring git remote with PAT token"
            git remote set-url origin https://$GH_TOKEN@github.com/${{ github.repository }}.git
          fi
          echo "Fetching tag: $TAG_REF"
          git fetch origin "$TAG_REF"
          git checkout "$TAG_REF"
          echo "Checked out: $TAG_REF"
        else
          echo "Using default checkout (main branch or no tag specified)"
        fi
      
    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION=${{ github.event.inputs.version }}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" == "workflow_run" ]; then
          VERSION="${{ needs.get-latest-tag.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        else
          # For main branch, use git describe to get version from latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          COMMIT_COUNT=$(git rev-list --count ${LATEST_TAG}..HEAD 2>/dev/null || echo "0")
          BASE_VERSION=${LATEST_TAG#v}
          if [ "$COMMIT_COUNT" -gt "0" ]; then
            VERSION="${BASE_VERSION}.${COMMIT_COUNT}"
          else
            VERSION="$BASE_VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        fi
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=${{ steps.version.outputs.version }}
          type=raw,value=latest

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: CertA/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Run Trivy vulnerability scanner
      id: trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
        format: 'sarif'
        output: 'trivy-results.sarif'
      if: steps.version.outputs.version != '' && steps.version.outputs.version != 'latest'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always() && steps.version.outputs.version != '' && steps.trivy.outcome != 'skipped' && (steps.trivy.outcome == 'success' || steps.trivy.outcome == 'failure')
      with:
        sarif_file: 'trivy-results.sarif'

  release:
    needs: [build-docker, get-latest-tag]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}
      
    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION=${{ github.event.inputs.version }}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          # For workflow_run, get version from get-latest-tag job
          VERSION="${{ needs.get-latest-tag.outputs.version }}"
          TAG="${{ needs.get-latest-tag.outputs.tag }}"
          TAG=${TAG#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
        fi
        
    - name: Get changelog
      id: changelog
      run: |
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        if [ -n "$PREVIOUS_TAG" ]; then
          CHANGELOG=$(git log --oneline --no-merges $PREVIOUS_TAG..HEAD | head -30)
        else
          CHANGELOG=$(git log --oneline --no-merges | head -30)
        fi
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: CertA ${{ steps.version.outputs.version }}
        body: |
          ## CertA ${{ steps.version.outputs.version }}
          
          **CertA** - Certificate Authority Management System
          
          ### üê≥ Docker Image
          
          Docker image is available:
          
          ```bash
          docker pull ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          ```
          
          Or use the latest tag:
          
          ```bash
          docker pull ${{ env.IMAGE_NAME }}:latest
          ```
          
          ### üöÄ What's New
          
          ```
          ${{ steps.changelog.outputs.changelog }}
          ```
          
          ### üîß Features
          
          - **Certificate Authority Management**: Self-signed root CA creation and management
          - **Certificate Generation**: Server, Client, Code Signing, Email, and Wildcard certificates
          - **Web Interface**: User-friendly certificate creation and management
          - **Multiple Formats**: PEM, PFX/PKCS#12 download options
          - **User Isolation**: Complete user isolation and data separation
          - **Database Storage**: PostgreSQL with Dapper for data access
          
          ### üìö Documentation
          
          For detailed documentation, see the [docs](https://github.com/${{ github.repository }}/tree/main/docs) directory.
          
          ### üê≥ Docker Compose
          
          ```yaml
          version: '3.8'
          services:
            postgres:
              image: postgres:15-alpine
              environment:
                POSTGRES_DB: certa
                POSTGRES_USER: certa
                POSTGRES_PASSWORD: certa123
              ports:
                - "5433:5432"
              
            certa-app:
              image: ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
              ports:
                - "8080:8080"
              environment:
                - ASPNETCORE_ENVIRONMENT=Production
                - ConnectionStrings__DefaultConnection=Host=postgres;Database=certa;Username=certa;Password=certa123;Port=5432
              depends_on:
                - postgres
          ```
          
          ### üîí Security
          
          This release has been scanned for vulnerabilities using Trivy.
        draft: false
        prerelease: false
